#include "Attributes.h"

#include <ros/ros.h>
#include <BaseEvent.h>
#include <ID.h>
#include <Unit.h>
#include <SensorEventPublisher.h>

#include <Eigen/Geometry>

using namespace ::id::attribute;
using namespace std;

namespace aseia_car_sim {

class NurbsPublisher {
  private:
    struct NurbsBaseConfig : public BaseConfig {
      using TimeValueType = Value<uint32_t, 1>;
      using TimeScale = Scale<std::ratio<1,1000>>;
      using PositionValueType = Value<float, 3>;
      using PositionScale = Scale<std::ratio<1>, 1>;
    };
    using Ref = Attribute<Reference, Value<float, 3>, Meter>;
    using Ori = Attribute<Orientation, Value<float, 4>, Radian>;
    using NurbData = Attribute<Nurbs, Value<float, 100, 4, false>, Meter, Scale<std::ratio<1>, 1>>;
    using NurbsReference = BaseEvent<NurbsBaseConfig>
                            ::append<Ref>::type
                            ::append<NurbData>::type
                            ::append<Ori>::type;
    ros::Timer mTimer;
    SensorEventPublisher<NurbsReference> mPub;
    NurbsReference mRef;

    void periodic(const ros::TimerEvent& e){
      mRef.attribute(Time()).value()={{{(uint32_t)ros::Time::now().toSec(), 0}}};
      mPub.publish(mRef);
    }
  public:
    NurbsPublisher()
      : mTimer(ros::NodeHandle().createTimer(ros::Duration(30), &NurbsPublisher::periodic, this))
    {
      mRef.attribute(Position()).value()={{{0, 0}},
                                          {{0, 0}},
                                          {{0, 0}}
                                          };
      mRef.attribute(Reference()).value()={{{0.0f, 0}},
                                           {{0.0f, 0}},
                                           {{-97.0f, 0}}
                                          };
      Eigen::Quaternionf q =   Eigen::AngleAxisf(0.0f*M_PI/180, Eigen::Vector3f::UnitX())
                             * Eigen::AngleAxisf(0.0f*M_PI/180, Eigen::Vector3f::UnitY())
                             * Eigen::AngleAxisf(0.0f*M_PI/180, Eigen::Vector3f::UnitZ());
      mRef.attribute(Orientation()).value()={{{q.x(), 0}},
                                             {{q.y(), 0}},
                                             {{q.z(), 0}},
                                             {{q.w(), 0}}
                                            };
      mRef.attribute(Nurbs()).value()={{{   3       }, {  27       }, { 31       }, {5.0     }},
                                       {{-175.381989}, {- 85.089470}, {128.044647}, {0.000000}},
                                       {{-185.792740}, {- 28.090939}, {131.982025}, {0.033333}},
                                       {{-148.693283}, {-  8.011072}, {141.422775}, {0.066667}},
                                       {{-135.767715}, {  19.669754}, {145.193497}, {0.100000}},
                                       {{- 92.308044}, {  47.678600}, {148.671326}, {0.133333}},
                                       {{- 70.083031}, {  74.627258}, {151.597794}, {0.166667}},
                                       {{- 44.936569}, {  94.987488}, {152.134003}, {0.200000}},
                                       {{- 23.906092}, { 124.958298}, {154.494965}, {0.233333}},
                                       {{  19.872423}, { 147.852737}, {156.584091}, {0.266667}},
                                       {{  60.340809}, { 159.955414}, {152.554535}, {0.300000}},
                                       {{ 116.860626}, { 115.351936}, {131.449600}, {0.333333}},
                                       {{ 187.355072}, { 133.856308}, {114.495987}, {0.366667}},
                                       {{ 189.462631}, {  77.951187}, { 90.612328}, {0.400000}},
                                       {{ 160.424301}, {  19.961811}, {105.674576}, {0.433333}},
                                       {{ 134.539719}, {- 10.825297}, {107.517906}, {0.466667}},
                                       {{ 109.042671}, {- 33.477707}, {107.084198}, {0.500000}},
                                       {{  80.559502}, {- 66.867294}, {109.289062}, {0.533333}},
                                       {{  12.065499}, {- 69.071754}, { 99.907921}, {0.566667}},
                                       {{- 28.879875}, {-106.820595}, { 99.621056}, {0.600000}},
                                       {{- 39.359058}, {-129.624268}, {100.226334}, {0.633333}},
                                       {{- 58.811153}, {-167.691254}, { 97.563271}, {0.666667}},
                                       {{- 87.937126}, {-181.971954}, { 95.940804}, {0.700000}},
                                       {{-115.313354}, {-182.447220}, { 97.146904}, {0.733333}},
                                       {{-187.483292}, {-173.815720}, { 95.406151}, {0.766667}},
                                       {{-175.381989}, {- 85.089470}, {128.044647}, {0.800000}},
                                       {{-185.792740}, {- 28.090939}, {131.982025}, {0.833333}},
                                       {{-148.693283}, {-  8.011072}, {141.422775}, {0.866667}},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.900000}},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.933333}},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.966667}},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {1.000000}},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                       {{   0.000000}, {   0.000000}, {  0.000000}, {0.0     }},
                                      };
    }
};
}

int main(int argc, char** argv) {
  ros::init(argc, argv, "nurbs");
  aseia_car_sim::NurbsPublisher nurbs;
  while(ros::ok())
    ros::spin();
  return 0;
}
